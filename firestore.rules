rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ---------- HELPERS ----------
    function signedIn() { return request.auth != null; }

    function userHasType(t) {
      return signedIn() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             (
               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.user_type == t ||
               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.selected_role == t ||
               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == t ||
               (t == "admin" && (
                 get(/databases/$(database)/documents/users/$(request.auth.uid)).data.is_admin == true ||
                 get(/databases/$(database)/documents/users/$(request.auth.uid)).data.admin == true
               )) ||
               (
                 get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles is list &&
                 get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.hasAny([t])
               )
             );
    }

    function isAdmin() {
      return signedIn() && (
        request.auth.token.admin == true ||
        userHasType("admin")
      );
    }

    /* ===============================
       ADMIN APP CONFIG (Subscription)
       - Frontend reads: app_config/subscription
       - Only admins can write/toggle
       =============================== */
    match /app_config/{docId} {
      allow read: if signedIn();
      allow write: if isAdmin();
    }

    // ===============================
    // INVITES
    // - Created/accepted/revoked ONLY via Cloud Functions
    // ===============================
    match /invites/{inviteId} {
      allow read, write: if false;
    }

    // ✅ Creators who can post
    function isCreatorRole() {
      return signedIn() && (userHasType("agent") || userHasType("tutor") || userHasType("school"));
    }

    // ✅ Post helpers (support camelCase + snake_case owner fields)
    function isPostOwnerFromData(d) {
      return signedIn() && (
        (d.authorId is string && d.authorId == request.auth.uid) ||
        (d.author_id is string && d.author_id == request.auth.uid) ||
        (d.user_id is string && d.user_id == request.auth.uid)
      );
    }
    function isPostOwnerResource() { return isPostOwnerFromData(resource.data); }
    function isPostOwnerRequest()  { return isPostOwnerFromData(request.resource.data); }

    function statusIs(d, s) {
      return d.keys().hasAny(["status"]) && d.status == s;
    }
    function statusMissing(d) {
      return !d.keys().hasAny(["status"]);
    }

    // ✅ rename params (avoid "Invalid variable name: resource" warnings)
    function isOwner(resDoc) {
      return signedIn() && resDoc.data.user_id == request.auth.uid;
    }
    function ownerCreating() {
      return signedIn() && request.resource.data.user_id == request.auth.uid;
    }

    // Also recognizes school_profiles ownership
    function ownsSchoolId(sid) {
      return signedIn() && (
        (exists(/databases/$(database)/documents/School/$(sid)) &&
         get(/databases/$(database)/documents/School/$(sid)).data.user_id == request.auth.uid) ||
        (exists(/databases/$(database)/documents/schools/$(sid)) &&
         get(/databases/$(database)/documents/schools/$(sid)).data.user_id == request.auth.uid) ||
        (exists(/databases/$(database)/documents/school_profiles/$(sid)) &&
          (
            sid == request.auth.uid ||
            get(/databases/$(database)/documents/school_profiles/$(sid)).data.user_id == request.auth.uid
          )
        )
      );
    }


    function ownsInstitutionId(iid) {
      return signedIn() && (
        (exists(/databases/$(database)/documents/institutions/$(iid)) &&
         get(/databases/$(database)/documents/institutions/$(iid)).data.user_id == request.auth.uid)
      );
    }

    // NEW: student whose assigned_agent_id points at this agent's user_id
    function isStudentOfAgent(agentRes) {
      return signedIn() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.assigned_agent_id == agentRes.data.user_id;
    }

    function canAccessReservation(resvRes) {
      return signedIn() && (
        resvRes.data.student_id == request.auth.uid ||
        ownsSchoolId(resvRes.data.school_id)
      );
    }

    function publiclyListable(resDoc) {
      return resDoc != null && (
        resDoc.data.is_visible == true ||
        resDoc.data.verification_status == "verified" ||
        resDoc.data.is_verified == true
      );
    }

    // ---------- Registration validators (ULTRA-MINIMAL) ----------
    function hasGuestEventRegistrationFields() {
      return
        (request.resource.data.event_id is string) &&
        (request.resource.data.role is string) &&
        (request.resource.data.contact_name is string) &&
        (request.resource.data.contact_email is string) &&
        (request.resource.data.reservation_code is string) &&
        (!request.resource.data.keys().hasAny(['user_id']));
    }

    function hasAuthedEventRegistrationFields() {
      return
        (request.resource.data.event_id is string) &&
        (request.resource.data.role is string) &&
        (request.resource.data.contact_name is string) &&
        (request.resource.data.contact_email is string) &&
        (request.resource.data.reservation_code is string) &&
        (request.resource.data.user_id is string) &&
        (request.resource.data.user_id == request.auth.uid);
    }

    function isRegColl(name) {
      return [
        'registration','registrations',
        'EventRegistration','EventRegistrations',
        'event_registration','event_registrations','eventRegistrations',
        'ExhibitorRegistration','ExhibitorRegistrations',
        'exhibitor_registration','exhibitor_registrations','exhibitorRegistrations',
        'StudentRSVP','student_rsvps'
      ].hasAny([name]);
    }

    // ---------- PROGRAM HELPERS ----------
    function validProgramCreate() {
      // Support legacy fields (schoolId/programTitle/programLevel) and new fields
      // (institution_id|institutionId, program_title, program_level)
      return signedIn()
        && (
          // legacy (school-based)
          (
            (request.resource.data.schoolId is string) &&
            (request.resource.data.programTitle is string) &&
            (request.resource.data.programLevel is string) &&
            (isAdmin() || ownsSchoolId(request.resource.data.schoolId))
          )
          ||
          // new (institution-based)
          (
            (
              (request.resource.data.institution_id is string) ||
              (request.resource.data.institutionId is string)
            ) &&
            (request.resource.data.program_title is string) &&
            (request.resource.data.program_level is string) &&
            (
              isAdmin() ||
              ownsInstitutionId(
                request.resource.data.institution_id != null ? request.resource.data.institution_id : request.resource.data.institutionId
              )
            )
          )
        );
    }

    function validProgramUpdate() {
      return signedIn()
        && (
          isAdmin()
          ||
          // legacy (school-based)
          (
            ((resource.data.schoolId is string) || (resource.data.school_id is string)) &&
            (
              request.resource.data.schoolId == null ||
              request.resource.data.schoolId == (
                resource.data.schoolId != null ? resource.data.schoolId : resource.data.school_id
              )
            ) &&
            ownsSchoolId(resource.data.schoolId != null ? resource.data.schoolId : resource.data.school_id)
          )
          ||
          // new (institution-based)
          (
            (
              (resource.data.institution_id is string) ||
              (resource.data.institutionId is string)
            ) &&
            (
              request.resource.data.institution_id == null ||
              request.resource.data.institution_id == (
                resource.data.institution_id != null ? resource.data.institution_id : resource.data.institutionId
              )
            ) &&
            (
              request.resource.data.institutionId == null ||
              request.resource.data.institutionId == (
                resource.data.institution_id != null ? resource.data.institution_id : resource.data.institutionId
              )
            ) &&
            ownsInstitutionId(resource.data.institution_id != null ? resource.data.institution_id : resource.data.institutionId)
          )
        );
    }

    // ---------- COMMON EMAIL/SESSION HELPERS ----------
    function sameEmail(a, b) {
      return a != null && b != null && a == b;
    }

    function authEmail() {
      return signedIn() ? request.auth.token.email : null;
    }

    // Check if caller is the tutor of a TutoringSession doc (by uid OR email OR app user id fields)
    function isTutorOfSession(resDoc) {
      return signedIn() && (
        resDoc.data.tutor_auth_uid == request.auth.uid ||
        resDoc.data.tutor_uid == request.auth.uid ||
        resDoc.data.tutor_id == request.auth.uid ||
        sameEmail(authEmail(), resDoc.data.tutor_email) ||
        (
          exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          (
            resDoc.data.tutor_id == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.user_id ||
            resDoc.data.tutor_id == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.uid ||
            resDoc.data.tutor_id == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.id
          )
        )
      );
    }

    // Check if caller is the student of a TutoringSession doc (by uid OR email OR app user id fields)
    function isStudentOfSession(resDoc) {
      return signedIn() && (
        resDoc.data.student_auth_uid == request.auth.uid ||
        resDoc.data.student_uid == request.auth.uid ||
        resDoc.data.student_id == request.auth.uid ||
        sameEmail(authEmail(), resDoc.data.student_email) ||
        (
          exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          (
            resDoc.data.student_id == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.user_id ||
            resDoc.data.student_id == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.uid ||
            resDoc.data.student_id == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.id
          )
        )
      );
    }

    function canReadSession(resDoc) { return isAdmin() || isTutorOfSession(resDoc) || isStudentOfSession(resDoc); }
    function canWriteSession(resDoc) { return isAdmin() || isTutorOfSession(resDoc) || isStudentOfSession(resDoc); }

    // ===========================
    // Messaging System (NO AI BOT)
    // ===========================

    // ---- Role normalization (rules-side) ----
    function normRole(v) {
      return v == null ? "" :
        (
          (v == "student" || v == "users" || v == "user") ? "user" :
          (v == "agents" || v == "agent") ? "agent" :
          (v == "tutors" || v == "tutor") ? "tutor" :
          (v == "schools" || v == "school") ? "school" :
          (v == "support") ? "support" :
          (v == "admin") ? "admin" :
          (v == "vendor") ? "vendor" :
          ""
        );
    }

    function roleFromUserDoc(d) {
      return normRole(
        (d.role is string ? d.role :
          (d.selected_role is string ? d.selected_role :
            (d.user_type is string ? d.user_type :
              (d.userType is string ? d.userType : ""))))
      );
    }

    // Treat the special "support" id as support without requiring a /users doc.
    function roleOfUid(uid) {
      return uid == "support" ? "support" :
        (
          exists(/databases/$(database)/documents/users/$(uid))
            ? roleFromUserDoc(get(/databases/$(database)/documents/users/$(uid)).data)
            : ""
        );
    }

    function forbiddenUserSchoolPair(aRole, bRole) {
      return (aRole == "user" && bRole == "school") || (aRole == "school" && bRole == "user");
    }

    // ✅ FIXED: accept participants_map values that are NOT boolean true (ex: role strings)
    function docMentionsUid(d) {
      return signedIn() && (
        (d.participants is list && d.participants.hasAny([request.auth.uid])) ||
        (d.participant_ids is list && d.participant_ids.hasAny([request.auth.uid])) ||
        (d.user_ids is list && d.user_ids.hasAny([request.auth.uid])) ||
        (d.members is list && d.members.hasAny([request.auth.uid])) ||
        (d.users is list && d.users.hasAny([request.auth.uid])) ||

        // ✅ maps: just check key exists (value can be true OR role OR timestamp)
        (d.participants_map is map && d.participants_map[request.auth.uid] != null) ||
        (d.participantsMap is map && d.participantsMap[request.auth.uid] != null) ||
        (d.participants_by_uid is map && d.participants_by_uid[request.auth.uid] != null) ||

        (d.user_id is string && d.user_id == request.auth.uid) ||
        (d.owner_id is string && d.owner_id == request.auth.uid) ||
        (d.created_by is string && d.created_by == request.auth.uid) ||
        (d.createdBy is string && d.createdBy == request.auth.uid) ||

        (d.from_user_id is string && d.from_user_id == request.auth.uid) ||
        (d.to_user_id is string && d.to_user_id == request.auth.uid) ||
        (d.sender_id is string && d.sender_id == request.auth.uid) ||
        (d.senderId is string && d.senderId == request.auth.uid) ||

        (d.agent_id is string && d.agent_id == request.auth.uid) ||
        (d.tutor_id is string && d.tutor_id == request.auth.uid) ||
        (d.student_id is string && d.student_id == request.auth.uid)
      );
    }

    function reqSenderId() {
      return request.resource.data.keys().hasAny(["sender_id"])
        ? request.resource.data.sender_id
        : (request.resource.data.keys().hasAny(["senderId"])
          ? request.resource.data.senderId
          : (request.resource.data.keys().hasAny(["from_user_id"])
            ? request.resource.data.from_user_id
            : null));
    }

    function reqRecipientId() {
      return request.resource.data.keys().hasAny(["to_user_id"])
        ? request.resource.data.to_user_id
        : (request.resource.data.keys().hasAny(["recipient_id"])
          ? request.resource.data.recipient_id
          : (request.resource.data.keys().hasAny(["toUserId"])
            ? request.resource.data.toUserId
            : null));
    }

    function reqConvId() {
      return request.resource.data.keys().hasAny(["conversation_id"])
        ? request.resource.data.conversation_id
        : (request.resource.data.keys().hasAny(["conversationId"])
          ? request.resource.data.conversationId
          : (request.resource.data.keys().hasAny(["thread_id"])
            ? request.resource.data.thread_id
            : (request.resource.data.keys().hasAny(["threadId"])
              ? request.resource.data.threadId
              : null)));
    }

    function resConvId() {
      return resource.data.keys().hasAny(["conversation_id"])
        ? resource.data.conversation_id
        : (resource.data.keys().hasAny(["conversationId"])
          ? resource.data.conversationId
          : (resource.data.keys().hasAny(["thread_id"])
            ? resource.data.thread_id
            : (resource.data.keys().hasAny(["threadId"])
              ? resource.data.threadId
              : null)));
    }

    // ✅ Policy: Students/Users can NEVER message School directly.
    function pairAllowedByUids(aUid, bUid) {
      return !forbiddenUserSchoolPair(roleOfUid(aUid), roleOfUid(bUid));
    }

    function pairAllowedForConversationCreate(d) {
      return
        (
          (d.participants is list && d.participants.size() == 2)
            ? pairAllowedByUids(d.participants[0], d.participants[1])
            : (
                (d.from_user_id is string && d.to_user_id is string)
                  ? pairAllowedByUids(d.from_user_id, d.to_user_id)
                  : true
              )
        );
    }

    match /config/{docId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    match /app_settings/{docId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    match /message_usage/{studentId}/months/{mk} {
      allow read: if signedIn() && (request.auth.uid == studentId || isAdmin());
      allow create, update: if signedIn() && (request.auth.uid == studentId || isAdmin());
      allow delete: if false;
    }

    match /messaging_settings/{docId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    match /conversations/{docId} {
      allow create: if signedIn() &&
        docMentionsUid(request.resource.data) &&
        pairAllowedForConversationCreate(request.resource.data);

      allow read: if signedIn();

      allow update: if isAdmin() || (
        docMentionsUid(resource.data) &&
        request.resource.data.diff(resource.data).changedKeys()
          .hasOnly(["last_message_at", "last_message_text", "updated_at"])
      );

      allow delete: if false;

      match /messages/{messageId} {
        allow create: if signedIn() &&
          (reqSenderId() == request.auth.uid) &&
          (
            reqRecipientId() == null ||
            pairAllowedByUids(reqSenderId(), reqRecipientId())
          ) &&
          (
            isAdmin() ||
            docMentionsUid(get(/databases/$(database)/documents/conversations/$(docId)).data) ||
            docMentionsUid(request.resource.data)
          ) &&
          (
            !request.resource.data.keys().hasAny(["conversation_id","conversationId","thread_id","threadId"]) ||
            reqConvId() == docId
          );

        allow read: if signedIn() && (
          isAdmin() ||
          docMentionsUid(get(/databases/$(database)/documents/conversations/$(docId)).data) ||
          docMentionsUid(resource.data)
        );

        allow update, delete: if false;
      }
    }

    match /messages/{docId} {
      allow create: if signedIn() &&
        (reqSenderId() == request.auth.uid) &&
        (
          reqRecipientId() == null ||
          pairAllowedByUids(reqSenderId(), reqRecipientId())
        );

      allow read: if signedIn() && (
        isAdmin() ||
        docMentionsUid(resource.data) ||
        (
          (resConvId() is string) &&
          exists(/databases/$(database)/documents/conversations/$(resConvId())) &&
          docMentionsUid(get(/databases/$(database)/documents/conversations/$(resConvId())).data)
        )
      );

      allow update, delete: if false;
    }

    match /reports/{docId} {
      // Allow any signed-in user to create a report ABOUT A CONVERSATION,
      // but only if they are the reporter (supports both snake_case and camelCase fields).
      allow create: if signedIn() && (
        (request.resource.data.reporter_id == request.auth.uid) ||
        (request.resource.data.reporterId == request.auth.uid)
      );

      // Only admins can view/triage reports
      allow read, update, delete: if isAdmin();
    }

    match /AboutPageContent/{docId} { allow read, write: if isAdmin(); }

    match /about_page_contents/{docId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    match /Agent/{docId} {
      allow read: if publiclyListable(resource) || isOwner(resource) || isAdmin();
      allow create: if ownerCreating();
      allow update, delete: if isAdmin() || isOwner(resource);
    }

    match /AgentPackage/{docId} {
      allow create: if signedIn();
      allow read: if signedIn();
      allow update, delete: if signedIn() && resource.data.user_id == request.auth.uid;
    }

    match /Asset/{docId} { allow read: if true; allow write: if false; }

    match /BankSettings/{docId} {
      allow create: if signedIn();
      allow read: if signedIn();
      allow update, delete: if signedIn() && resource.data.user_id == request.auth.uid;
    }

    match /BrandSettings/{docId} { allow read, write: if isAdmin(); }

    match /Case/{docId} {
      allow create: if signedIn() && (
        request.resource.data.student_id == request.auth.uid ||
        request.resource.data.user_id == request.auth.uid
      );

      allow read, update, delete: if signedIn() && (
        resource.data.student_id == request.auth.uid ||
        resource.data.user_id == request.auth.uid ||
        isAdmin()
      );
    }

    match /cases/{docId} {

      function isAgentOfStudent(studentId) {
        return signedIn() && (
          // Manually-added client relationship
          exists(/databases/$(database)/documents/agent_students/$(request.auth.uid + "_" + studentId))
          // OR referral-based assignment
          || (
            exists(/databases/$(database)/documents/users/$(studentId)) &&
            get(/databases/$(database)/documents/users/$(studentId)).data.referred_by_agent_id == request.auth.uid
          )
        );
      }

      allow create: if signedIn() && (
        request.resource.data.student_id == request.auth.uid ||
        request.resource.data.user_id == request.auth.uid ||
        request.resource.data.agent_id == request.auth.uid ||
        isAdmin()
      );

      allow read: if signedIn() && (
        resource.data.student_id == request.auth.uid ||
        resource.data.user_id == request.auth.uid ||
        resource.data.agent_id == request.auth.uid ||
        isAgentOfStudent(resource.data.student_id) ||
        isAdmin()
      );

      allow update, delete: if signedIn() && (
        resource.data.student_id == request.auth.uid ||
        resource.data.user_id == request.auth.uid ||
        resource.data.agent_id == request.auth.uid ||
        isAdmin()
      );
    }

    match /chatSettings/{docId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    match /Contact/{docId} {
      allow create: if signedIn();
      allow read: if signedIn();
      allow update, delete: if signedIn() && resource.data.user_id == request.auth.uid;
    }

    match /ContactPageContent/{docId} { allow read, write: if isAdmin(); }

    match /Conversation/{docId} {
      allow create: if signedIn() && request.resource.data.user_id == request.auth.uid;
      allow read, update, delete: if signedIn() && resource.data.user_id == request.auth.uid;
    }

    match /Event/{docId} { allow read: if true; allow write: if false; }

    match /EventAssignment/{docId} {
      allow create: if signedIn() && request.resource.data.user_id == request.auth.uid;
      allow read, update, delete: if signedIn() && resource.data.user_id == request.auth.uid;
    }

    match /EventRegistration/{docId} {
      allow create: if isAdmin() || hasAuthedEventRegistrationFields() || hasGuestEventRegistrationFields();
      allow read, update, delete: if (signedIn() && resource.data.user_id == request.auth.uid) || isAdmin();
    }
    match /event_registrations/{docId} {
      allow create: if isAdmin() || hasAuthedEventRegistrationFields() || hasGuestEventRegistrationFields();
      allow read, update, delete: if (signedIn() && resource.data.user_id == request.auth.uid) || isAdmin();
    }
    match /{path=**}/EventRegistration/{docId} {
      allow create: if isAdmin() || hasAuthedEventRegistrationFields() || hasGuestEventRegistrationFields();
      allow read, update, delete: if (signedIn() && resource.data.user_id == request.auth.uid) || isAdmin();
    }
    match /{path=**}/event_registrations/{docId} {
      allow create: if isAdmin() || hasAuthedEventRegistrationFields() || hasGuestEventRegistrationFields();
      allow read, update, delete: if (signedIn() && resource.data.user_id == request.auth.uid) || isAdmin();
    }

    match /ExhibitorRegistration/{docId} {
      allow create: if isAdmin() || hasAuthedEventRegistrationFields() || hasGuestEventRegistrationFields();
      allow read, update, delete: if (signedIn() && resource.data.user_id == request.auth.uid) || isAdmin();
    }
    match /exhibitor_registrations/{docId} {
      allow create: if isAdmin() || hasAuthedEventRegistrationFields() || hasGuestEventRegistrationFields();
      allow read, update, delete: if (signedIn() && resource.data.user_id == request.auth.uid) || isAdmin();
    }

    match /{path=**}/{coll}/{docId} {
      allow create: if isRegColl(coll) && (hasAuthedEventRegistrationFields() || hasGuestEventRegistrationFields());
    }

    match /FAQ/{docId} { allow read: if true; allow write: if false; }

    match /FairEvent/{docId} {
      allow create: if signedIn();
      allow read: if signedIn();
      allow update, delete: if signedIn() && resource.data.user_id == request.auth.uid;
    }

    match /HomePageContent/{docId} { allow read, write: if isAdmin(); }

    match /Institution/{docId} {
      allow create: if signedIn();
      allow read: if signedIn();
      allow update, delete: if signedIn() && (resource.data.user_id == request.auth.uid || isAdmin());
    }

    match /KnowledgeBase/{docId} { allow read: if true; allow write: if false; }

    match /Lead/{docId} {
      allow create: if signedIn();
      allow read: if signedIn();
      allow update, delete: if signedIn() && resource.data.user_id == request.auth.uid;
    }

    match /MarketplaceOrder/{docId} {
      allow create: if signedIn() && request.resource.data.student_id == request.auth.uid;
      allow get, update, delete: if signedIn() && (
        resource.data.student_id == request.auth.uid || isAdmin()
      );
      allow list: if signedIn() && isAdmin();
    }

    match /Message/{docId} {
      allow create: if signedIn();
      allow read: if signedIn();
      allow update, delete: if signedIn() && resource.data.user_id == request.auth.uid;
    }

    match /OurTeamPageContent/{docId} {
      allow create: if signedIn();
      allow read: if signedIn();
      allow update, delete: if signedIn() && resource.data.user_id == request.auth.uid;
    }

    match /Package/{docId} {
      allow create: if signedIn();
      allow read: if signedIn();
      allow update, delete: if signedIn() && resource.data.user_id == request.auth.uid;
    }

    match /Payment/{docId} {
      allow create: if signedIn() && request.resource.data.user_id == request.auth.uid;
      allow read, update, delete: if (signedIn() && resource.data.user_id == request.auth.uid) || isAdmin();
    }

    // ==========================================
    // ✅ Posts (NO PAYWALL): /Post (legacy)
    // ==========================================
    match /Post/{docId} {
      allow read: if
        statusIs(resource.data, "published") ||
        statusMissing(resource.data) ||
        isPostOwnerResource() ||
        isAdmin();

      allow create: if isCreatorRole()
        && isPostOwnerRequest()
        && (
          statusMissing(request.resource.data) ||
          statusIs(request.resource.data, "draft") ||
          statusIs(request.resource.data, "published")
        );

      allow update: if isAdmin() || (isCreatorRole() && isPostOwnerResource());
      allow delete: if isAdmin() || (isCreatorRole() && isPostOwnerResource());
    }

    match /Registration/{docId} {
      allow create: if signedIn();
      allow read: if signedIn();
      allow update, delete: if signedIn() && resource.data.user_id == request.auth.uid;
    }

    match /Reservation/{docId} {
      allow create: if signedIn() && request.resource.data.student_id == request.auth.uid;
      allow read: if isAdmin() || canAccessReservation(resource);
      allow update: if isAdmin() || canAccessReservation(resource);
      allow delete: if isAdmin() || (signedIn() && resource.data.student_id == request.auth.uid);
    }

    match /School/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /SchoolProfile/{docId} {
      allow create: if (signedIn() && request.resource.data.user_id == request.auth.uid) || isAdmin();
      allow read: if ((resource != null && isOwner(resource)) || (docId == request.auth.uid)) || isAdmin();
      allow update, delete: if (resource != null && isOwner(resource)) ||
                             (request.resource.data.user_id == request.auth.uid) ||
                             isAdmin();
    }

    match /Service/{docId} {
      allow create: if signedIn();
      allow read: if signedIn();
      allow update, delete: if signedIn() && resource.data.user_id == request.auth.uid;
    }

    match /StudentRSVP/{docId} {
      allow create: if isAdmin() || hasAuthedEventRegistrationFields() || hasGuestEventRegistrationFields();
      allow read, update, delete: if (signedIn() && resource.data.user_id == request.auth.uid) || isAdmin();
    }

    match /StudentTutorPackage/{docId} {
      allow create: if signedIn();
      allow read: if signedIn();
      allow update, delete: if signedIn() && resource.data.user_id == request.auth.uid;
    }

    match /SupportAgent/{docId} {
      allow create: if ownerCreating();
      allow read, update, delete: if isOwner(resource);
    }

    match /SupportTicket/{docId} {
      allow create: if ownerCreating();
      allow read, update, delete: if isOwner(resource);
    }

    match /Vendor/{docId} {
      allow get: if publiclyListable(resource) || isOwner(resource) || isAdmin();
      allow list: if signedIn() && isAdmin();
      allow create: if ownerCreating();
      allow update, delete: if isAdmin() || isOwner(resource);
    }

    match /vendors/{docId} {
      allow get: if publiclyListable(resource) || isOwner(resource) || isAdmin();
      allow list: if signedIn() && isAdmin();
      allow create: if ownerCreating();
      allow update, delete: if isAdmin() || isOwner(resource);
    }

    match /VisaDocument/{docId} {
      allow create: if ownerCreating();
      allow read, update, delete: if isOwner(resource) || isAdmin();
    }
    match /visaDocuments/{docId} {
      allow create: if ownerCreating();
      allow read, update, delete: if isOwner(resource) || isAdmin();
    }
    match /visa_documents/{docId} {
      allow create: if ownerCreating();
      allow read, update, delete: if isOwner(resource) || isAdmin();
    }

    match /visaPackages/{docId} { allow read: if true; allow create, update, delete: if isAdmin(); }
    match /VisaPackages/{docId} { allow read: if true; allow create, update, delete: if isAdmin(); }
    match /visa_packages/{docId} { allow read: if true; allow create, update, delete: if isAdmin(); }
    match /tutor_packages/{docId} { allow read: if true; allow create, update, delete: if isAdmin(); }
    match /student_tutor_packages/{docId} { allow read: if true; allow create, update, delete: if isAdmin(); }

    match /VisaRequest/{docId} {
      allow create: if signedIn() && request.resource.data.student_id == request.auth.uid;
      allow read, update, delete: if signedIn() && resource.data.student_id == request.auth.uid;
    }

    match /Wallet/{docId} {
      allow create: if ownerCreating();
      allow read, update, delete: if isOwner(resource);
    }

    match /WalletTransaction/{docId} {
      allow create: if ownerCreating();
      allow read, update, delete: if isOwner(resource);
    }

    match /mail/{docId} {
      allow create: if isAdmin();
      allow read, update, delete: if false;
    }

    // ============================
    // Invites
    // ============================
    // Security model: invites are created/accepted/revoked ONLY via Cloud Functions
    // (Admin SDK). Clients should not be able to read tokens or tamper with invites.
    match /invites/{inviteId} {
      allow read, write: if false;
    }

    match /promotions/{id} {
      allow read: if true;

      function validPromotion() {
        return request.resource.data.keys().hasOnly([
          "title_en","title_vi","subtitle_en","subtitle_vi",
          "description_en","description_vi","image_url",
          "price_label_en","price_label_vi",
          "registration_fee_label_en","registration_fee_label_vi",
          "location_en","location_vi","tags_en","tags_vi",
          "cta_label_en","cta_label_vi","cta_link",
          "start_date","end_date","is_active","priority"
        ]) &&
        request.resource.data.image_url is string &&
        request.resource.data.cta_link is string &&
        request.resource.data.is_active is bool &&
        request.resource.data.priority is number;
      }

      allow create, update, delete: if isAdmin() && validPromotion();
    }

    // ===== ALIASES used by the app =====
    match /home_page_content/{docId} { allow read: if true; allow write: if isAdmin(); }
    match /home_page_contents/{docId} { allow read: if true; allow write: if isAdmin(); }
    match /ourTeam/{docId} { allow read: if true; allow write: if isAdmin(); }
    match /contactPage/{docId} { allow read: if true; allow create, update, delete: if isAdmin(); }
    match /contact_page_content/{docId} { allow read: if true; allow create, update, delete: if isAdmin(); }
    match /contact_page_contents/{docId} { allow read: if true; allow create, update, delete: if isAdmin(); }
    match /contacts/{docId} { allow create: if true; allow read, update, delete: if isAdmin(); }

    // ==========================================
    // ✅ Posts (NO PAYWALL): /posts (main)
    // ==========================================
    match /posts/{docId} {
      allow read: if
        statusIs(resource.data, "published") ||
        statusMissing(resource.data) ||
        isPostOwnerResource() ||
        isAdmin();

      allow create: if isCreatorRole()
        && isPostOwnerRequest()
        && (
          statusMissing(request.resource.data) ||
          statusIs(request.resource.data, "draft") ||
          statusIs(request.resource.data, "published")
        );

      allow update: if isAdmin() || (isCreatorRole() && isPostOwnerResource());
      allow delete: if isAdmin() || (isCreatorRole() && isPostOwnerResource());
    }

    match /events/{docId} {
      // Public read: events are meant to be discoverable
      allow read: if true;

      // Event ownership (support a few common field names to avoid breaking older docs)
      function isEventOwnerData(d) {
        return signedIn() && (
          (d.host_uid is string && d.host_uid == request.auth.uid) ||
          (d.user_id is string && d.user_id == request.auth.uid) ||
          (d.owner_id is string && d.owner_id == request.auth.uid)
        );
      }
      function isEventOwnerResource() { return isEventOwnerData(resource.data); }
      function isEventOwnerRequest()  { return isEventOwnerData(request.resource.data); }

      // Minimal field validation for create/update (keeps the collection clean)
      function validPlatform(p) { return ["nasio","eventbrite"].hasAny([p]); }
      function validUrl(u) {
        return (u is string) && (u.size() > 10) && (u.matches('^https://.*'));
      }

      // Role ↔ platform constraints
      function roleAllowsPlatform(p) {
        return
          (userHasType("school") && p == "eventbrite") ||
          (userHasType("tutor") && p == "nasio") ||
          (userHasType("agent") && (p == "nasio" || p == "eventbrite"));
      }

      function validEventWrite() {
        return signedIn() &&
          (request.resource.data.title is string) &&
          (request.resource.data.title.size() > 1) &&
          (request.resource.data.start != null) &&
          (request.resource.data.end != null) &&
          (request.resource.data.platform is string) &&
          validPlatform(request.resource.data.platform) &&
          roleAllowsPlatform(request.resource.data.platform) &&
          (request.resource.data.external_url is string) &&
          validUrl(request.resource.data.external_url) &&
          // creator must own the event
          (request.resource.data.host_uid is string) &&
          (request.resource.data.host_uid == request.auth.uid);
      }

      // ✅ Admin has full control
      allow create, update, delete: if isAdmin();

      // ✅ Creators can create events for themselves (external-only)
      allow create: if isCreatorRole() && validEventWrite();

      // ✅ Creators can update/delete only their own events
      allow update, delete: if isCreatorRole() && isEventOwnerResource() && isEventOwnerRequest() && validEventWrite();
    }
    match /faqs/{docId} { allow read: if true; allow write: if false; }

    match /Program/{docId} {
      allow read: if true;
      allow create: if isAdmin() || validProgramCreate();
      allow update: if isAdmin() || validProgramUpdate();
      allow delete: if isAdmin() || validProgramUpdate();
    }
    match /programs/{docId} {
      allow read: if true;
      allow create: if isAdmin() || validProgramCreate();
      allow update: if isAdmin() || validProgramUpdate();
      allow delete: if isAdmin() || validProgramUpdate();
    }
    match /school_programs/{docId} {
      allow read: if true;
      allow create: if isAdmin() || validProgramCreate();
      allow update: if isAdmin() || validProgramUpdate();
      allow delete: if isAdmin() || validProgramUpdate();
    }

    match /schools/{docId} {
      allow read: if true;

      // PROGRAM DOCS inside `schools`
      // - school_id = institutions/{institutionUid}
      // - user_id   = auth.uid
      // - optional: record_type = "program"
      allow create: if signedIn() && (
        isAdmin() ||

        (
          request.resource.data.user_id == request.auth.uid &&
          request.resource.data.school_id is string &&
          ownsInstitutionId(request.resource.data.school_id)
        )
      );

      allow update: if signedIn() && (
        isAdmin() ||

        (
          resource.data.user_id == request.auth.uid &&
          resource.data.school_id is string &&
          ownsInstitutionId(resource.data.school_id) &&
          // prevent changing the school_id to something else
          (request.resource.data.school_id == null || request.resource.data.school_id == resource.data.school_id)
        )
      );

      allow delete: if signedIn() && (
        isAdmin() ||

        (
          resource.data.user_id == request.auth.uid &&
          resource.data.school_id is string &&
          ownsInstitutionId(resource.data.school_id)
        )
      );
    }

    match /users/{docId} {
      function resUserRole(resDoc) {
        return roleFromUserDoc(resDoc.data);
      }

      allow get, list: if
        isAdmin() ||
        signedIn() ||
        (
          publiclyListable(resource) &&
          ["agent","tutor","school"].hasAny([resUserRole(resource)])
        );

      allow create: if signedIn();
      allow update, delete: if signedIn() && (
        docId == request.auth.uid ||
        resource.data.user_id == request.auth.uid ||
        isAdmin()
      );

      match /messaging_usage/{mk} {
        allow get, list: if signedIn() && (request.auth.uid == docId || isAdmin());
        allow create, update: if signedIn() && (request.auth.uid == docId || isAdmin());
        allow delete: if false;
      }

      match /following/{creatorId} {
        allow get, list: if signedIn() && request.auth.uid == docId;
        // Server-only: created by Cloud Functions on accepted follow requests
        allow create, update: if false;
        allow delete: if signedIn() && request.auth.uid == docId;
      }

      match /followers/{followerId} {
        allow get, list: if signedIn() && (request.auth.uid == docId || request.auth.uid == followerId || isAdmin());
        // Server-only: created by Cloud Functions on accepted follow requests
        allow create, update: if false;
        allow delete: if signedIn() && (request.auth.uid == followerId || request.auth.uid == docId || isAdmin());
      }
// ---------- FOLLOW REQUESTS (Instagram-style) ----------
// A follow starts as a request:
// users/{followee}/follow_requests/{follower}
// Followee can accept/decline by updating status.
match /follow_requests/{followerId} {
  // Followee sees incoming requests; follower can read their own request doc (to show "Requested")
  allow get, list: if signedIn() && (request.auth.uid == docId || request.auth.uid == followerId || isAdmin());

  // Follower creates a pending request under the followee
  allow create: if signedIn()
    && request.auth.uid == followerId
    && request.resource.data.follower_id == followerId
    && request.resource.data.followee_id == docId
    && request.resource.data.status == "pending";

  // Followee accepts/declines
  allow update: if signedIn()
    && request.auth.uid == docId
    && request.resource.data.follower_id == followerId
    && request.resource.data.followee_id == docId
    && (request.resource.data.status == "accepted" || request.resource.data.status == "declined");

  // Either side can cancel/delete the request
  allow delete: if signedIn() && (request.auth.uid == docId || request.auth.uid == followerId || isAdmin());
}

// Outgoing requests mirror for sender UI (optional).
// users/{follower}/follow_requests_sent/{followee}
match /follow_requests_sent/{followeeId} {
  allow get, list: if signedIn() && (request.auth.uid == docId || isAdmin());

  // Allow sender to create/delete their own mirror doc (if your UI writes it).
  // If you want this server-only, change these two lines to "if false;"
  allow create: if signedIn() && request.auth.uid == docId && request.resource.data.followee_id == followeeId;
  allow delete: if signedIn() && request.auth.uid == docId;
  allow update: if false;
}
      match /feed/{postId} {
        allow get, list: if signedIn() && request.auth.uid == docId;
        allow create, update, delete: if false; // server only
      }

      match /notifications/{nid} {
        allow get, list: if signedIn() && request.auth.uid == docId;
        allow create: if false;
        allow update: if signedIn()
                      && request.auth.uid == docId
                      && request.resource.data.diff(resource.data).changedKeys()
                        .hasOnly(["seen", "readAt"]);
        allow delete: if signedIn() && request.auth.uid == docId;
      }
    }

    match /school_profiles/{uid} {
      allow read: if isAdmin() ||
                  (signedIn() && (
                    uid == request.auth.uid ||
                    (resource != null && resource.data.user_id == request.auth.uid)
                  ));

      allow create: if signedIn() && (isAdmin() || request.resource.data.user_id == request.auth.uid);
      allow update, delete: if signedIn() && (isAdmin() || (resource != null && resource.data.user_id == request.auth.uid));
    }

    match /services/{docId} {
      allow create: if signedIn();
      allow read: if signedIn();
      allow update, delete: if signedIn() && (
        resource.data.user_id == request.auth.uid || isAdmin()
      );
    }

    match /leads/{docId} {
      allow create: if signedIn();
      allow read: if signedIn();
      allow update, delete: if signedIn() && resource.data.user_id == request.auth.uid;
    }

    match /institutions/{docId} {
      allow read: if true;
      allow create: if signedIn() && (isAdmin() || request.resource.data.user_id == request.auth.uid);
      allow update, delete: if signedIn() && (isAdmin() || resource.data.user_id == request.auth.uid);
    }
    match /Institutions/{docId} { allow read: if true; allow write: if isAdmin(); }
    match /Schools/{docId}      { allow read: if true; allow write: if isAdmin(); }

    match /payments/{docId} {
      allow create: if signedIn() && request.resource.data.user_id == request.auth.uid;
      allow read, update, delete: if (signedIn() && resource.data.user_id == request.auth.uid) || isAdmin();
    }

    match /reservations/{docId} {
      allow create: if signedIn() && request.resource.data.student_id == request.auth.uid;
      allow read: if isAdmin() || canAccessReservation(resource);
      allow update: if isAdmin() || canAccessReservation(resource);
      allow delete: if isAdmin() || (signedIn() && resource.data.student_id == request.auth.uid);
    }

    match /marketplace_orders/{docId} {
      allow create: if signedIn() && request.resource.data.student_id == request.auth.uid;
      allow get, update, delete: if signedIn() && (
        resource.data.student_id == request.auth.uid || isAdmin()
      );
      allow list: if signedIn() && isAdmin();
    }
    match /marketplaceOrders/{docId} {
      allow create: if signedIn() && request.resource.data.student_id == request.auth.uid;
      allow get, update, delete: if signedIn() && (
        resource.data.student_id == request.auth.uid || isAdmin()
      );
      allow list: if signedIn() && isAdmin();
    }

    match /tutors/{docId} {
      allow get: if publiclyListable(resource) || isOwner(resource) || isAdmin();
      allow list: if true;
      allow create: if ownerCreating();
      allow update, delete: if isAdmin() || isOwner(resource);
    }

    match /TutoringSession/{docId} {
      allow create: if signedIn() && canWriteSession(request.resource);
      allow read: if signedIn() && canReadSession(resource);
      allow update, delete: if signedIn() && canWriteSession(resource);
    }

    match /tutoring_sessions/{docId} {
      allow create: if signedIn() && canWriteSession(request.resource);
      allow read: if signedIn() && canReadSession(resource);
      allow update, delete: if signedIn() && canWriteSession(resource);
    }

    match /wallets/{docId} {
      allow create: if ownerCreating();
      allow read, update, delete: if isOwner(resource);
    }
    match /walletTransactions/{docId} {
      allow create: if ownerCreating();
      allow read, update, delete: if isOwner(resource);
    }
    match /wallet_transactions/{docId} {
      allow create: if ownerCreating();
      allow read, update, delete: if isOwner(resource);
    }

    match /agents/{docId} {
      allow read: if
        publiclyListable(resource) ||
        isOwner(resource) ||
        isStudentOfAgent(resource) ||
        isAdmin();

      allow create: if ownerCreating();
      allow update, delete: if isAdmin() || isOwner(resource);
    }

    match /agent_messages/{docId} {
      allow create: if signedIn() &&
                    request.resource.data.from_user_id == request.auth.uid;

      allow read: if signedIn() && (
        resource.data.from_user_id == request.auth.uid ||
        resource.data.to_user_id == request.auth.uid ||
        isAdmin()
      );

      allow update, delete: if false;
    }

    match /bank_accounts/{docId} {
      allow create: if signedIn();
      allow read: if signedIn();
      allow update, delete: if signedIn() && resource.data.user_id == request.auth.uid;
    }
    match /bank_settings/{docId} { allow read, create, update, delete: if isAdmin(); }

    match /payment_settings/{docId} { allow read: if true; allow create, update, delete: if isAdmin(); }
    match /paymentSettings/{docId}  { allow read: if true; allow create, update, delete: if isAdmin(); }
    match /PaymentSettings/{docId}  { allow read: if true; allow create, update, delete: if isAdmin(); }
    match /paymentSetting/{docId}   { allow read: if true; allow create, update, delete: if isAdmin(); }
    match /PaymentSetting/{docId}   { allow read: if true; allow create, update, delete: if isAdmin(); }

    match /brandSettings/{docId} { allow read, write: if isAdmin(); }
    match /chat_settings/{docId} { allow read: if true; allow create, update, delete: if isAdmin(); }

    match /translations_public/{docId} {
      allow read: if true;
      allow write: if false; // only server (Admin SDK) writes
    }


    match /tutor_students/{relId} {
      // Tutor ↔ Student relationship
      // Doc shape: { tutor_id: string, student_id: string, ... }

      function myAppUserId() {
        return exists(/databases/$(database)/documents/users/$(request.auth.uid))
          && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.id is string)
          ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.id
          : "";
      }

      function isTutorOwner() {
        return signedIn() && (
          resource.data.tutor_id == request.auth.uid ||
          (myAppUserId() != "" && resource.data.tutor_id == myAppUserId())
        );
      }

      allow create: if signedIn()
        && (
          request.resource.data.tutor_id == request.auth.uid ||
          (myAppUserId() != "" && request.resource.data.tutor_id == myAppUserId())
        )
        && request.resource.data.student_id is string;

      allow read: if signedIn()
        && (isTutorOwner()
            || resource.data.student_id == request.auth.uid
            || isAdmin());

      // Update: tutor owner only, and cannot change tutor_id/student_id
      allow update: if isTutorOwner()
        && request.resource.data.tutor_id == resource.data.tutor_id
        && request.resource.data.student_id == resource.data.student_id;

      // Delete: tutor owner (no request.resource.data)
      allow delete: if isTutorOwner() || isAdmin();
    }


    match /agent_students/{relId} {
      // Agent ↔ Student (Client) relationship
      // Doc shape: { agent_id: string, student_id: string, ... }

      function myAppUserId() {
        return exists(/databases/$(database)/documents/users/$(request.auth.uid))
          && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.id is string)
          ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.id
          : "";
      }

      function isAgentOwner() {
        return signedIn() && (
          resource.data.agent_id == request.auth.uid ||
          (myAppUserId() != "" && resource.data.agent_id == myAppUserId())
        );
      }

      allow create: if signedIn()
        && (
          request.resource.data.agent_id == request.auth.uid ||
          (myAppUserId() != "" && request.resource.data.agent_id == myAppUserId())
        )
        && request.resource.data.student_id is string;

      allow read: if signedIn()
        && (isAgentOwner()
            || resource.data.student_id == request.auth.uid
            || isAdmin());

      // Update: agent owner only, and cannot change agent_id/student_id
      allow update: if isAgentOwner()
        && request.resource.data.agent_id == resource.data.agent_id
        && request.resource.data.student_id == resource.data.student_id;

      // Delete: agent owner (no request.resource.data)
      allow delete: if isAgentOwner() || isAdmin();
    }

    // final catch-all

    // ✅ Agent document checklist per client
    // Collection: agent_client_checklists/{agentId}_{clientId}
    // Fields: { agent_id, client_id, documents: [{id,name,submitted,...}], ... }
    match /agent_client_checklists/{docId} {
      allow create: if signedIn() && (
        request.resource.data.agent_id == request.auth.uid || isAdmin()
      );

      allow read: if signedIn() && (
        resource.data.agent_id == request.auth.uid ||
        resource.data.client_id == request.auth.uid ||
        isAdmin()
      );

      allow update, delete: if signedIn() && (
        resource.data.agent_id == request.auth.uid || isAdmin()
      );
    }

    
/* ===============================
   ORGANIZATIONS (Team seats)
   - org owner/admin manages org
   - baseSlots=5 free, extraSlots paid
   - usedSlots increments when members join
   =============================== */

function orgRef(orgId) {
  return /databases/$(database)/documents/organizations/$(orgId);
}

function orgExists(orgId) {
  return orgId is string && exists(orgRef(orgId));
}

function isOrgOwner(orgId) {
  return signedIn() && orgExists(orgId) && get(orgRef(orgId)).data.ownerId == request.auth.uid;
}

function isOrgMember(orgId) {
  // membership doc id is deterministic: {orgId}_{uid}
  return signedIn()
    && (orgId is string)
    && exists(/databases/$(database)/documents/organization_members/$(orgId + "_" + request.auth.uid));
}

function canUseOrgFeature() {
  // Subscription gate: only applies to school/agent/tutor when subscription mode is enabled
  // subscription doc: app_config/subscription { enabled: true/false }
  // if not enabled, allow.
  // if enabled, require user doc subscribed==true (or subscription_active==true)
  return signedIn() && (
    !exists(/databases/$(database)/documents/app_config/subscription) ||
    get(/databases/$(database)/documents/app_config/subscription).data.enabled != true ||
    !(userHasType("school") || userHasType("agent") || userHasType("tutor")) ||
    (
      exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
      (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.subscribed == true ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.subscription_active == true ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.subscriptionActive == true
      )
    )
  );
}

match /organizations/{orgId} {
  allow read: if signedIn() && (isAdmin() || isOrgOwner(orgId) || isOrgMember(orgId));

  // Create org: school/agent/tutor (gated) or admin. OwnerId must be caller.
  allow create: if signedIn()
    && canUseOrgFeature()
    && (isAdmin() || userHasType("school") || userHasType("agent") || userHasType("tutor"))
    && request.resource.data.ownerId == request.auth.uid
    && request.resource.data.baseSlots == 5
    && request.resource.data.extraSlots == 0
    && request.resource.data.usedSlots >= 0;

  // Update org: owner/admin only. Prevent lowering usedSlots below current.
  allow update: if signedIn()
    && (isAdmin() || isOrgOwner(orgId))
    && request.resource.data.ownerId == resource.data.ownerId
    && request.resource.data.usedSlots >= resource.data.usedSlots;

  allow delete: if signedIn() && (isAdmin() || isOrgOwner(orgId));
}

match /organization_members/{memberId} {
  function memberOrgId() { return resource.data.orgId; }
  function newMemberOrgId() { return request.resource.data.orgId; }

  // Read: admin/owner OR any member in the same org (so members can see the roster)
  allow read: if signedIn() && (
    isAdmin() ||
    (resource.data.orgId is string && (isOrgOwner(resource.data.orgId) || isOrgMember(resource.data.orgId)))
  );

  // Client create: only when creating org owner member (the initial addDoc)
  // This is needed because org creation currently adds owner member from frontend.
  allow create: if signedIn()
    && canUseOrgFeature()
    && request.resource.data.userId == request.auth.uid
    && request.resource.data.role == "owner"
    && request.resource.data.orgId is string
    && isOrgOwner(request.resource.data.orgId);

  // All other member writes are server-only (accept invite runs in Cloud Function)
  allow update, delete: if false;
}

// ===============================
// ORG INVITES (server writes only)
// ===============================
match /org_invites/{inviteId} {
  allow read: if signedIn() && (
    isAdmin() ||
    (resource.data.orgId is string && isOrgOwner(resource.data.orgId))
  );
  allow create, update, delete: if false;
}


    match /{document=**} { allow read, write: if false; }
  }
}
